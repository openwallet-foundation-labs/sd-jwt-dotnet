#!/bin/sh
# Automatically add Signed-off-by line to commit message if not present
#
# This hook is called by "git commit" with one argument, the name of the file
# that has the commit message. The hook should exit with non-zero status after
# issuing an appropriate message if it wants to stop the commit.

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

# Get the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Extract the subject line (first line without comments)
SUBJECT_LINE=$(grep -v "^#" "$COMMIT_MSG_FILE" | head -n 1)

# Regex to validate Conventional Commits: 'type(scope)!: subject' or 'type: subject'
# Allowed types: feat, fix, docs, chore, test, refactor, perf, ci, build, revert, style
REGEX="^(feat|fix|docs|chore|test|refactor|perf|ci|build|revert|style)(\([a-z0-9_-]+\))?!?: .+"

if ! echo "$SUBJECT_LINE" | grep -Eq "$REGEX"; then
    echo "ERROR: Commit message must follow Conventional Commits syntax." >&2
    echo "Expected format: <type>[optional scope]: <description>" >&2
    echo "Example: feat(api): add new endpoints" >&2
    echo "Allowed types: feat, fix, docs, chore, test, refactor, perf, ci, build, revert, style" >&2
    echo "Your commit message: $SUBJECT_LINE" >&2
    exit 1
fi

# Get git user info
NAME=$(git config user.name)
EMAIL=$(git config user.email)

# Create sign-off line
SIGN_OFF="Signed-off-by: $NAME <$EMAIL>"

# Check if sign-off already exists in the message
if ! grep -q "^Signed-off-by: " "$COMMIT_MSG_FILE"; then
    # Add sign-off line to the commit message
    echo "" >> "$COMMIT_MSG_FILE"
    echo "$SIGN_OFF" >> "$COMMIT_MSG_FILE"
    echo "âœ“ Added: $SIGN_OFF" >&2
fi
