#!/usr/bin/env bash
# Pre-commit hook to auto-format code and Markdown
# Automatically fixes formatting issues before committing
# Cross-platform: Works on Linux, macOS, and Windows (Git Bash)

set -e

echo "Running pre-commit auto-formatting..."

# Auto-fix C# code formatting (support both Unix and Windows paths)
echo "Auto-formatting C# code..."
format_output=$(dotnet format --verbosity quiet SdJwt.Net.sln 2>&1) || format_exit=$?

if [ -z "${format_exit}" ]; then
    # dotnet format succeeded
    echo "C# formatting applied."
elif [ ${format_exit} -eq 127 ]; then
    # Command not found
    echo "Warning: dotnet not found, skipping C# format check."
else
    # Formatting failed
    echo ""
    echo "ERROR: Failed to format C# code."
    echo "Please check your code for syntax errors."
    exit 1
fi

# Auto-fix Markdown formatting for staged files
staged_md_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

if [ -n "$staged_md_files" ]; then
    file_count=$(echo "$staged_md_files" | wc -l | tr -d ' ')
    echo "Auto-formatting ${file_count} staged Markdown file(s)..."

    # Apply Prettier formatting
    if echo "$staged_md_files" | xargs npx --yes prettier@3.2.5 --write; then
        # Re-stage the formatted files
        echo "$staged_md_files" | xargs git add
        echo "Markdown formatting applied and files re-staged."
    else
        echo ""
        echo "ERROR: Failed to format Markdown files."
        exit 1
    fi
else
    echo "No staged Markdown files to format."
fi

echo "All formatting complete - code is ready for commit."
