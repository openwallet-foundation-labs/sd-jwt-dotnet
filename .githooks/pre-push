#!/usr/bin/env bash
# Pre-push hook to verify Markdown formatting with Prettier
# Prevents pushing code with Markdown style issues

set -e

echo "Running pre-push checks..."

# Get changed markdown files between local and remote
changed_md=$(git diff --name-only @{u}..HEAD -- '*.md' 2>/dev/null || git diff --name-only HEAD~1 HEAD -- '*.md' 2>/dev/null || true)

if [[ -n "${changed_md}" ]]; then
    existing_files=()
    while IFS= read -r file; do
        [[ -n "${file}" && -f "${file}" ]] && existing_files+=("${file}")
    done <<< "${changed_md}"

    if [[ ${#existing_files[@]} -gt 0 ]]; then
        echo "Checking Markdown formatting: ${existing_files[*]}"
        if ! npx --yes prettier@3.2.5 --check "${existing_files[@]}"; then
            echo ""
            echo "ERROR: Markdown formatting issues detected."
            echo "Run: npx prettier@3.2.5 --write <files>"
            echo "Or run: ./scripts/verify.ps1 (includes all checks)"
            exit 1
        fi
        echo "Markdown formatting check passed."
    fi
else
    echo "No changed Markdown files to check."
fi

echo "Pre-push checks passed."
