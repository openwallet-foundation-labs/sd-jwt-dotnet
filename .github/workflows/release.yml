# This workflow publishes the complete SD-JWT .NET ecosystem to NuGet.org upon a new GitHub Release.
name: Release and Publish SD-JWT .NET Ecosystem

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering for testing
    inputs:
      dry-run:
        description: 'Perform a dry run (build and pack but do not publish)'
        required: false
        default: false
        type: boolean
      ecosystem-validation:
        description: 'Perform enhanced ecosystem validation'
        required: false
        default: true
        type: boolean

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  # Job 1: Build, test, and pack using the reusable workflow
  build-and-test:
    uses: ./.github/workflows/reusable-build.yml
    with:
      dotnet-version: '9.0.x'
      configuration: 'Release'
      enable-code-coverage: true

  # Job 2: Validate complete ecosystem and publish to NuGet
  publish-ecosystem:
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: production  # Use environment for additional protection

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./packages

    - name: Validate complete SD-JWT .NET ecosystem
      run: |
        echo "ğŸ” Validating complete SD-JWT .NET ecosystem packages..."
        
        # Define complete ecosystem packages
        declare -A ecosystem_packages=(
          ["SdJwt.Net"]="Core SD-JWT functionality with RFC 9901 compliance"
          ["SdJwt.Net.Vc"]="Verifiable Credentials with draft-ietf-oauth-sd-jwt-vc-13"
          ["SdJwt.Net.StatusList"]="Credential lifecycle management with draft-ietf-oauth-status-list-13"
          ["SdJwt.Net.Oid4Vci"]="Credential issuance with OpenID4VCI 1.0"
          ["SdJwt.Net.Oid4Vp"]="Presentation protocols with OpenID4VP 1.0"
          ["SdJwt.Net.OidFederation"]="Trust infrastructure with OpenID Federation 1.0"
          ["SdJwt.Net.PresentationExchange"]="Intelligent credential selection with DIF PE v2.1.1"
          ["SdJwt.Net.HAIP"]="High assurance compliance with HAIP 1.0"
        )
        
        echo "ğŸ“¦ Expected ecosystem packages:"
        for package in "${!ecosystem_packages[@]}"; do
          echo "  â€¢ $package: ${ecosystem_packages[$package]}"
        done
        echo ""
        
        found_packages=()
        missing_packages=()
        
        for package in "${!ecosystem_packages[@]}"; do
          if ls ./packages/${package}.*.nupkg 1> /dev/null 2>&1; then
            package_file=$(ls ./packages/${package}.*.nupkg | grep -v symbols | head -1)
            size=$(du -h "$package_file" | cut -f1)
            echo "âœ… Found: $package ($size)"
            found_packages+=("$package")
          else
            echo "âŒ Missing: $package"
            missing_packages+=("$package")
          fi
        done
        
        echo ""
        echo "ğŸ“Š Ecosystem Validation Summary:"
        echo "  âœ… Found: ${#found_packages[@]}/${#ecosystem_packages[@]} packages"
        echo "  âŒ Missing: ${#missing_packages[@]} packages"
        
        if [ ${#missing_packages[@]} -gt 0 ]; then
          echo ""
          echo "ğŸš¨ ERROR: Incomplete ecosystem detected!"
          echo "Missing packages: ${missing_packages[*]}"
          echo "Cannot proceed with ecosystem release."
          exit 1
        fi
        
        echo ""
        echo "âœ… Complete SD-JWT .NET ecosystem validated!"

    - name: Enhanced package integrity validation
      if: inputs.ecosystem-validation == true || github.event_name == 'release'
      run: |
        echo "ğŸ”¬ Enhanced package integrity validation..."
        
        for package in ./packages/*.nupkg; do
          if [[ ! "$package" =~ \.symbols\. ]] && [[ -f "$package" ]]; then
            package_name=$(basename "$package")
            echo ""
            echo "ğŸ” Validating: $package_name"
            
            # Check package size
            size=$(stat -c%s "$package" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            
            if [ "$size" -lt 10000 ]; then
              echo "  âš ï¸  WARNING: Small package size: ${size_kb}KB"
            else
              echo "  âœ… Package size OK: ${size_kb}KB"
            fi
            
            # Validate package structure
            echo "  ğŸ“‹ Package structure:"
            dotnet nuget list package-details "$package" 2>/dev/null | head -10 || echo "  (Package details not available)"
            
            # Check for expected version pattern
            if [[ "$package_name" =~ \.(1\.0\.0)\. ]]; then
              echo "  âœ… Version 1.0.0 confirmed"
            else
              echo "  âš ï¸  WARNING: Unexpected version pattern"
            fi
          fi
        done
        
        echo ""
        echo "âœ… Enhanced package validation completed"

    - name: List ecosystem packages to be published
      run: |
        echo "ğŸ“‹ SD-JWT .NET Ecosystem packages ready for publication:"
        echo ""
        
        main_packages=()
        symbol_packages=()
        
        for package in ./packages/*.nupkg; do
          package_name=$(basename "$package")
          if [[ "$package" =~ \.symbols\. ]]; then
            symbol_packages+=("$package_name")
          else
            main_packages+=("$package_name")
          fi
        done
        
        echo "ğŸ“¦ Main packages (${#main_packages[@]}):"
        for package in "${main_packages[@]}"; do
          echo "  â€¢ $package"
        done
        
        echo ""
        echo "ğŸ” Symbol packages (${#symbol_packages[@]}):"
        for package in "${symbol_packages[@]}"; do
          echo "  â€¢ $package"
        done

    - name: Check for required secrets
      if: github.event_name != 'workflow_dispatch' || inputs.dry-run != true
      run: |
        if [[ -z "${{ secrets.NUGET_API_KEY }}" ]]; then
          echo "âŒ NUGET_API_KEY secret is not set"
          exit 1
        fi
        echo "âœ… Required secrets are available"

    - name: Dry run - Show ecosystem publication plan
      if: github.event_name == 'workflow_dispatch' && inputs.dry-run == true
      run: |
        echo "ğŸ§ª DRY RUN MODE - SD-JWT .NET Ecosystem Publication Plan"
        echo ""
        echo "The following packages would be published to NuGet.org:"
        echo ""
        
        total_size=0
        package_count=0
        
        for package in ./packages/*.nupkg; do
          if [[ ! "$package" =~ \.symbols\. ]]; then
            package_name=$(basename "$package")
            size=$(stat -c%s "$package" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            total_size=$((total_size + size))
            package_count=$((package_count + 1))
            
            echo "  ğŸ“¦ $package_name (${size_kb}KB)"
          fi
        done
        
        total_size_mb=$((total_size / 1024 / 1024))
        echo ""
        echo "ğŸ“Š Publication Summary:"
        echo "  â€¢ Total packages: $package_count"
        echo "  â€¢ Total size: ${total_size_mb}MB"
        echo ""
        echo "ğŸ§ª DRY RUN - No actual publishing performed"

    - name: Publish main ecosystem packages to NuGet
      if: github.event_name != 'workflow_dispatch' || inputs.dry-run != true
      run: |
        echo "ğŸš€ Publishing SD-JWT .NET Ecosystem to NuGet.org..."
        echo ""
        
        success_count=0
        total_count=0
        failed_packages=()
        
        for package in ./packages/*.nupkg; do
          # Skip symbol packages for main upload
          if [[ ! "$package" =~ \.symbols\. ]]; then
            total_count=$((total_count + 1))
            package_name=$(basename "$package")
            
            echo "ğŸ“¦ Publishing: $package_name"
            echo "   Target: NuGet.org"
            echo "   Status: In progress..."
            
            if dotnet nuget push "$package" \
              --api-key ${{ secrets.NUGET_API_KEY }} \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate \
              --timeout 300; then
              echo "   Result: âœ… SUCCESS"
              success_count=$((success_count + 1))
            else
              echo "   Result: âŒ FAILED"
              failed_packages+=("$package_name")
            fi
            echo "   ---"
          fi
        done
        
        echo ""
        echo "ğŸ“Š Main Packages Publication Summary:"
        echo "  âœ… Successful: $success_count/$total_count"
        echo "  âŒ Failed: ${#failed_packages[@]}"
        
        if [ ${#failed_packages[@]} -gt 0 ]; then
          echo ""
          echo "âŒ Failed packages:"
          for package in "${failed_packages[@]}"; do
            echo "  â€¢ $package"
          done
          echo ""
          echo "ğŸš¨ Some ecosystem packages failed to publish!"
          exit 1
        fi
        
        echo ""
        echo "ğŸ‰ All main ecosystem packages published successfully!"

    - name: Publish symbol packages to NuGet
      if: (github.event_name != 'workflow_dispatch' || inputs.dry-run != true) && success()
      run: |
        echo "ğŸ” Publishing symbol packages to NuGet.org..."
        echo ""
        
        symbol_count=0
        symbol_success=0
        
        for package in ./packages/*symbols*.nupkg; do
          if [[ -f "$package" ]]; then
            symbol_count=$((symbol_count + 1))
            package_name=$(basename "$package")
            echo "ğŸ” Publishing symbol package: $package_name"
            
            if dotnet nuget push "$package" \
              --api-key ${{ secrets.NUGET_API_KEY }} \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate \
              --timeout 300; then
              echo "   âœ… Successfully published symbol package"
              symbol_success=$((symbol_success + 1))
            else
              echo "   âš ï¸ Failed to publish symbol package (continuing...)"
            fi
          fi
        done
        
        echo ""
        if [[ $symbol_count -eq 0 ]]; then
          echo "â„¹ï¸ No symbol packages found"
        else
          echo "ğŸ“Š Symbol packages: $symbol_success/$symbol_count published"
        fi

    - name: Create comprehensive release summary
      if: success()
      run: |
        release_version="${GITHUB_REF#refs/tags/}"
        
        echo "# ğŸš€ SD-JWT .NET Ecosystem $release_version Released Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The complete SD-JWT .NET ecosystem has been published to NuGet.org!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“¦ Published Ecosystem Packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        declare -A package_descriptions=(
          ["SdJwt.Net"]="ğŸ” Core SD-JWT functionality with RFC 9901 compliance"
          ["SdJwt.Net.Vc"]="ğŸ“„ Verifiable Credentials with draft-13 support"
          ["SdJwt.Net.StatusList"]="ğŸ”„ Credential lifecycle management"
          ["SdJwt.Net.Oid4Vci"]="ğŸ­ Credential issuance with OpenID4VCI 1.0"
          ["SdJwt.Net.Oid4Vp"]="ğŸ“± Presentation protocols with OpenID4VP 1.0"
          ["SdJwt.Net.OidFederation"]="ğŸ¤ Trust infrastructure with OpenID Federation 1.0"
          ["SdJwt.Net.PresentationExchange"]="ğŸ§  Intelligent credential selection with DIF PE v2.1.1"
          ["SdJwt.Net.HAIP"]="ğŸ›¡ï¸ High assurance compliance with HAIP 1.0"
        )
        
        for package in ./packages/*.nupkg; do
          if [[ ! "$package" =~ \.symbols\. ]]; then
            package_name=$(basename "$package" .nupkg | sed 's/\.[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*//')
            if [[ -n "${package_descriptions[$package_name]}" ]]; then
              echo "- **\`$package_name\`** - ${package_descriptions[$package_name]}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **\`$package_name\`**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“‹ [NuGet.org packages](https://www.nuget.org/profiles/thomas-tran)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“– [Documentation](https://github.com/openwallet-foundation-labs/sd-jwt-dotnet/tree/main/docs)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸš€ [Getting Started](https://github.com/openwallet-foundation-labs/sd-jwt-dotnet/blob/main/docs/samples/getting-started.md)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¯ [Financial Co-Pilot Demo](https://github.com/openwallet-foundation-labs/sd-jwt-dotnet/blob/main/docs/samples/scenarios/financial/)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“‹ [Release notes](${{ github.event.release.html_url }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ› ï¸ Installation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Install complete ecosystem" >> $GITHUB_STEP_SUMMARY
        echo "dotnet add package SdJwt.Net" >> $GITHUB_STEP_SUMMARY
        echo "dotnet add package SdJwt.Net.Vc" >> $GITHUB_STEP_SUMMARY
        echo "dotnet add package SdJwt.Net.StatusList" >> $GITHUB_STEP_SUMMARY
        echo "dotnet add package SdJwt.Net.Oid4Vci" >> $GITHUB_STEP_SUMMARY
        echo "dotnet add package SdJwt.Net.Oid4Vp" >> $GITHUB_STEP_SUMMARY
        echo "dotnet add package SdJwt.Net.OidFederation" >> $GITHUB_STEP_SUMMARY
        echo "dotnet add package SdJwt.Net.PresentationExchange" >> $GITHUB_STEP_SUMMARY
        echo "dotnet add package SdJwt.Net.HAIP" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Post-publication validation
      if: success() && (github.event_name != 'workflow_dispatch' || inputs.dry-run != true)
      run: |
        echo "ğŸ” Performing post-publication validation..."
        echo ""
        
        # Wait a moment for NuGet indexing
        echo "â³ Waiting 30 seconds for NuGet.org indexing..."
        sleep 30
        
        # Try to verify packages are available (best effort)
        echo "ğŸ” Attempting to verify package availability..."
        
        packages_to_check=("SdJwt.Net" "SdJwt.Net.Vc" "SdJwt.Net.HAIP")
        
        for package in "${packages_to_check[@]}"; do
          echo "Checking: $package"
          if dotnet list package --source https://api.nuget.org/v3/index.json | grep -q "$package" 2>/dev/null; then
            echo "  âœ… Package appears to be available"
          else
            echo "  â„¹ï¸ Package not yet indexed (this is normal)"
          fi
        done
        
        echo ""
        echo "âœ… Post-publication validation completed"
        echo "ğŸ“ Note: It may take a few minutes for packages to appear in search results"

  ecosystem-announcement:
    needs: publish-ecosystem
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'release'
    
    steps:
    - name: Create ecosystem announcement
      run: |
        echo "ğŸ‰ SD-JWT .NET Ecosystem Release Complete!"
        echo ""
        echo "Version: ${GITHUB_REF#refs/tags/}"
        echo "Packages: 8 core ecosystem packages"
        echo "Standards: RFC 9901, OpenID4VCI/VP 1.0, DIF PE v2.1.1, HAIP 1.0"
        echo "Platforms: .NET 8, .NET 9, .NET Standard 2.1"
        echo ""
        echo "ğŸš€ The complete SD-JWT .NET ecosystem is now available on NuGet.org!"
